<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MÃ¤rklin Interface Controller</title>
<style>
  /* Reset and general styles */
  * { box-sizing: border-box; }
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    background: #111;
    color: #eee;
    padding: 20px;
    margin: 0;
  }

  h2, h3 {
    margin: 16px 0 8px 0;
    font-weight: 400;
  }

  /* Layout sections */
  header, .commands, .quick-actions, .line-status, .system-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-bottom: 12px;
  }

  /* Inputs and selects */
  input[type="number"], input[type="text"], select {
    padding: 6px 10px;
    border-radius: 5px;
    border: 1px solid #333;
    background: #111;
    color: #eee;
    font-size: 14px;
  }

  input[type="number"] { width: 60px; }

  /* Buttons */
  button {
    padding: 6px 14px;
    border-radius: 6px;
    border: 1px solid #444;
    background: #222;
    color: #fff;
    cursor: pointer;
    transition: 0.2s;
  }
  button:hover:not(:disabled) { background: #333; }
  button:disabled { opacity: 0.5; cursor: default; }

  /* Logs and output */
  #output, #log {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #333;
    background: #000;
    font-family: monospace;
    overflow-y: auto;
  }
  #output {
  width: 100%;
  height: 300px;
  background: #000;
  color: #bbb; /* changed from #0f0 to grayish */
  padding: 8px;
  overflow-y: auto;
  font-family: monospace;
}

  #log { color: #bfbfbf; height: 200px; margin-top: 8px; }

  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  th, td {
    border: 1px solid #333;
    padding: 6px;
    text-align: center;
    background: #0b0b0b;
  }
  th {
    position: sticky;
    top: 0;
    background: #161616;
    z-index: 2;
  }

  /* LEDs */
  .led {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #333;
    text-align: center;
    line-height: 20px;
    font-size: 10px;
    margin-right: 8px;
    transition: 0.2s;
  }
  .led.on { background: #0f0; }
  .led.error { background: #f00; }

  /* Footer */
  #footer { margin-top: 16px; color: #999; font-size: 12px; }

  .small { font-size: 12px; padding: 4px 8px; }
</style>
</head>
<body>

<h2>MÃ¤rklin Interface Web Console</h2>

<header>
  <label for="baudRateSelect">Baud Rate:</label>
  <select id="baudRateSelect">
    <option value="1200">1200</option>
    <option value="2400" selected>2400 default</option>
    <option value="3000">3000 can work</option>
    <option value="4800">4800</option>
  </select>
  <button id="connect">ðŸ”Œ Connect</button>
</header>

<div class="commands">
  <input id="cmd" placeholder="Enter ASCII command (e.g. M 1 R, L 5 S 10)">
  <button id="send">Send</button>
</div>

<h3>Quick Actions:</h3>
<div class="quick-actions">
  <button onclick="Stop()">Emergency Stop</button>
  <button onclick="Go()">Go</button>
</div>

<div class="commands">
  <input type="number" id="turnout" min="1" max="255" value="1">
  <label for="turnout">address</label>
  <select id="branch">
    <option value="0">red</option>
    <option value="1">green</option>
  </select>
  <button onclick="setSwitch(document.getElementById('turnout').value || 1,document.getElementById('branch').value)">Turnout Branch</button>
</div>

<div class="commands">
  <input type="number" id="OFF" min="1" max="255" value="1">
  <label for="OFF">address</label>
  <button onclick="SwitchOFF(document.getElementById('OFF').value)">Turnout OFF</button>
</div>

<div class="commands">
  <input type="number" id="gs88modul" min="1" max="16" value="1">
  <label for="gs88modul">S88 Module</label>
  <button onclick="getS88modul(document.getElementById('gs88modul').value || 1)">Read Module</button>

  <input type="number" id="gs88contact" min="1" max="992" value="1">
  <label for="gs88contact">S88 Contact</label>
  <button onclick="getS88contact(document.getElementById('gs88contact').value || 1)">Read Contact</button>
</div>

<div class="commands">
  <input type="number" id="Lok" min="1" max="80" value="1">
  <label for="Lok">address</label>
  <input type="number" id="Speed" min="1" max="14" value="1">
  <label for="Speed">Speed</label>
  <select id="Funktion">
    <option value=""></option>
    <option value="">F0 Off</option>
    <option value="0">F0 On</option>
    <option value="1">F1</option>
    <option value="2">F2</option>
    <option value="3">F3</option>
    <option value="4">F4</option>
    <option value="1+2">F1+F2</option>
    <option value="1+3">F1+F3</option>
    <option value="1+4">F1+F4</option>
    <option value="2+3">F2+F3</option>
    <option value="2+4">F2+F4</option>
    <option value="3+4">F3+F4</option>
    <option value="1+2+3">F1+F2+F3</option>
    <option value="1+2+4">F1+F2+F4</option>
    <option value="1+3+4">F1+F3+F4</option>
    <option value="2+3+4">F2+F3+F4</option>
    <option value="1+2+3+4">F1+F2+F3+F4</option>
  </select>
  <button onclick="Lok(document.getElementById('Lok').value || 1,document.getElementById('Speed').value, document.getElementById('Funktion').value)">Lok</button>
</div>

<div class="commands">
  <input type="number" id="LokDir" min="1" max="80" value="1">
  <label for="LokDir">address</label>
  <button onclick="LokDir(document.getElementById('LokDir').value || 1)">Change Direction</button>
</div>

<div class="commands">
  <select id="Echo">
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
  </select>
  <button onclick="EchoMode(document.getElementById('Echo').value)">Enable Echo Mode</button>
</div>

<h3>Line Status:</h3>
<div class="line-status" id="leds">
  <span id="led-cts" class="led">CTS</span>
  <span id="led-rx" class="led">RX</span>
  <span id="led-tx" class="led">TX</span>
  <span id="led-err" class="led">ERR</span>
</div>

<div class="system-buttons">
  <button onclick="setsystem(6050)">Set as 6050</button>
  <button onclick="setsystem(6023)">Set as 6023</button>
</div>

<h3>Received Data:</h3>
<div id="output"></div>
<script>
let type;
let port, reader, writer;
let lastResponse = "";
const output = document.getElementById('output');

function setSwitch(addr, direction){
   if(type=="6023"){
      if(direction == "0"){
	     direction = "R";
	  }
	  if(direction == "1"){
	     direction = "G";
	  }
      sendCmd("M " + addr + " " + direction);
   }
   if(type=="6050"){
      if(direction == "0"){
	     direction = "34";
	  }
	  if(direction == "1"){
	     direction = "33";
	  }
      sendCmd(direction + " " + addr);
   }
}
function getS88modul(addr){
   if(type=="6023"){
      sendCmd("A " + addr);
   }
   if(type=="6050"){
      addr = Number(addr) + Number("192");
      sendCmd(String(addr));
	  
   }
}

function getS88contact(addr){
   if(type=="6023"){
      sendCmd("C " + addr);
   }
   if(type=="6050"){
      addr = Number(addr) + Number("128");
      sendCmd(String(addr));
   }
}
function Stop(){
   if(type=="6023"){
      sendCmd("S");
   }
   if(type=="6050"){
      sendCmd("97");
   }
}
function Go(){
   if(type=="6023"){
      sendCmd("G");
   }
   if(type=="6050"){
      sendCmd("96");
   }
}
function Lok(addr,speed,funk){
   if(type=="6023"){
      if(funk==""){
      sendCmd("L "+addr+" S "+speed);
	  }
	  else{
	    if(isNaN(funk)){
	        log("only F0 is supported on 6023/6223");
		}
		else{
		    sendCmd("L "+addr+" S "+speed+" F "+funk);  
		}
	  }
   }
   if(type=="6050"){
      if(funk=="0"){
      speed=Number(speed) + Number("16");
      sendCmd(speed+" "+addr);
	  }
	  if(funk=="1"){
      sendCmd("65 "+addr);
	  }
	  if(funk=="2"){
      sendCmd("66 "+addr);
	  }
	  if(funk=="3"){
      sendCmd("68 "+addr);
	  }
	  if(funk=="4"){
      sendCmd("72 "+addr);
	  }
	  if(funk=="1+2"){
      sendCmd("67 "+addr);
	  }
	  if(funk=="1+3"){
      sendCmd("69 "+addr);
	  }
	  if(funk=="1+4"){
      sendCmd("73 "+addr);
	  }
	  if(funk=="2+3"){
      sendCmd("70 "+addr);
	  }
	  if(funk=="2+4"){
      sendCmd("74 "+addr);
	  }
	  if(funk=="3+4"){
      sendCmd("76 "+addr);
	  }
	  if(funk=="1+2+3"){
      sendCmd("71 "+addr);
	  }
	  if(funk=="2+3+4"){
      sendCmd("78 "+addr);
	  }
	  if(funk=="1+2+4"){
      sendCmd("75 "+addr);
	  }
	  if(funk=="1+3+4"){
      sendCmd("77 "+addr);
	  }
	  if(funk=="1+2+3+4"){
      sendCmd("79 "+addr);
	  }
	  
	  
	  if(funk==""){
      sendCmd(speed+" "+addr);
	  }
   }
}
function LokDir(addr){
   if(type=="6023"){
      sendCmd("L "+addr+" D");
   }
   if(type=="6050"){
      sendCmd("15 "+addr);
   }
}
function EchoMode(mode){
   if(type=="6023"){
      sendCmd("E "+mode);
   }
   if(type=="6050"){
      log("unsuported on 6050/6051");
   }
}

function SwitchOFF(addr){
	if(type=="6023"){
	  log("automated in 6023/6223");
   }
   if(type=="6050"){
      sendCmd("32 "+addr);
   }
}
	
function setsystem(system){
   type = system;
}
function log(text) {
  output.textContent += text + '\n';
  output.scrollTop = output.scrollHeight;
}
function blinkLED(id, duration = 100) {
  const led = document.getElementById(id);
  if (!led) return;
  led.classList.add('on');
  setTimeout(() => led.classList.remove('on'), duration);
}

function setErrorLED(on = true) {
  const led = document.getElementById('led-err');
  if (!led) return;
  if (on) led.classList.add('error');
  else led.classList.remove('error');
}

async function connect(baudRate=2400) {
  try {
    setErrorLED(false);
    // Ask for serial device
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: Number(baudRate), dataBits: 8, stopBits: 2, parity: 'none' });

    writer = port.writable.getWriter();
    reader = port.readable.getReader();

    log('âœ… Connected to MÃ¤rklin interface');
    checkType();
    // Start continuous reading loop
    startContinuousReadLoop();
    updateCTS();
  } catch (err) {
    log('âŒ ' + err);
	setErrorLED(true);
  }
}


// Continuously reads and logs all incoming serial data
async function startContinuousReadLoop() {
  const decoder = new TextDecoder();
  try {
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      if (value) {
	    blinkLED('led-rx', 100);
        const text = decoder.decode(value);
        const binaryString = Array.from(value)
           .map(byte => byte.toString(2).padStart(8, '0'))
           .join(' ');
           lastResponse = binaryString;
        log('RX: ' + binaryString);
      }
    }
  } catch (err) {
    log('âš ï¸ Read error: ' + err);
	setErrorLED(true);
  } finally {
    log('ðŸ”Œ Disconnected');
    reader.releaseLock();
  }
}

// Sends ASCII or binary command depending on format
async function sendCmd(command) {
  if (!writer) { log('âš ï¸ Not connected'); setErrorLED(true); return; }
  blinkLED('led-tx', 100);
  // Detect binary (numbers) or ASCII (letters)
  const isBinary = /^[0-9\s]+$/.test(command.trim());

  if (isBinary) {
    let parts = command.trim().split(/\s+/);
    const bytes = parts.map(n => parseInt(n)).filter(n => !isNaN(n) && n >= 0 && n <= 255);
    if (bytes.length === 0) { log('âš ï¸ Invalid input'); setErrorLED(true); return; }
    await writer.write(new Uint8Array(bytes));
    log('TX (BIN): ' + bytes.join(' '));
  } else {
    const fullCmd = command.trim() + '\r';
    await writer.write(new TextEncoder().encode(fullCmd));
    log('TX (ASCII): ' + command);
  }
  setErrorLED(false);
}
async function updateCTS() {
  const led = document.getElementById('led-cts');
  if (!port) {
    led.classList.remove('on');
    return;
  }
  try {
    const signals = await port.getSignals();
    if (signals.clearToSend) led.classList.add('on');
    else led.classList.remove('on');
  } catch (err) {
    // Adapter may not support CTS â€” simulate "connected" instead
    led.classList.add('on');
  }
  setTimeout(updateCTS, 200);
}
document.getElementById('connect').onclick = () => {
  const baudRate = Number(document.getElementById('baudRateSelect').value);
  connect(baudRate);
};


document.getElementById('send').onclick = () => {
  const cmdInput = document.getElementById('cmd').value;
  sendCmd(cmdInput);
};

// Trigger sendCmd when Enter is pressed in the input
document.getElementById('cmd').addEventListener('keydown', (event) => {
  if (event.key === 'Enter') {
    const cmdInput = document.getElementById('cmd').value;
    sendCmd(cmdInput);
  }
});




 // Clear lastResponse
  
  
async function checkType() {
  if (!writer) { log('âš ï¸ Not connected'); return; }
  const BINcmd = "129";
    const bytes = BINcmd.trim().split(/\s+/).map(n => parseInt(n)).filter(n => !isNaN(n) && n >= 0 && n <= 255);
    if (bytes.length === 0) { log('âš ï¸ Invalid binary input'); return; }

    lastResponse = "";
    await writer.write(new Uint8Array(bytes));

    const binResponse = await waitForResponse(1000);
 

  if (binResponse) {
    log('âœ… MÃ¤rklin 6050/6051 detected: ' + binResponse.trim());
	type = "6050";
  } else {
    log('âŒ No Binary response detected, trying ASCII mode');

    // Send binary test command
     lastResponse = "";

  // Send ASCII test command
  const ASCIIcmd = "A 1";
  const fullCmd = ASCIIcmd.trim() + '\r';
  await writer.write(new TextEncoder().encode(fullCmd));

  // Wait until lastResponse is updated or timeout
  const response = await waitForResponse(1000); // 1 second timeout
  
  
   
	  
	  
	  
	  
    if (response) {
      log('âœ… MÃ¤rklin 6023/6223 detected: ' + response.trim());
	  type = "6023";
    } else {
      log('âŒ No 6023/6223 response detected');
    }
  }
}

// Helper: resolves when lastResponse updates or timeout expires
function waitForResponse(timeoutMs) {
  return new Promise(resolve => {
    const start = performance.now();
    const interval = setInterval(() => {
      if (lastResponse && lastResponse.trim() !== "") {
        clearInterval(interval);
        resolve(lastResponse);
      } else if (performance.now() - start > timeoutMs) {
        clearInterval(interval);
        resolve(null);
      }
    }, 20); // check every 20ms
  });
}


</script>

</body>
</html>










